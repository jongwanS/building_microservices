# 8. 배포

## 8.1 논리적에서 물리적으로
- 논리적 관점은 많은 복잡성을 숨겨준다.
- 물리적으로 어떤 종류의 정보가 숨어 있는지 살펴보자.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/ae05ef80-8530-4f04-9878-0da7880d3390)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

### 8.1.1 다수 인스턴스
![image](https://github.com/jongwanS/building_microservices/assets/30585897/b107a009-9c80-45ef-a662-897fdebff5f3)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

![image](https://github.com/jongwanS/building_microservices/assets/30585897/b56a6d24-65d4-4036-aeaa-eb8e7168edcb)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

### 8.1.2 데이터베이스
- 마이크로서비스 **인스턴스마다** 자신의 데이터베이스를 가져야 할까? -> **아니다**
  - 상태 조회, 조작하는 로직은 **논리적으로 하나의 마이크로서비스** 이다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/8cce9d67-7b98-43a9-88c7-7309bab73d2f)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축

#### [데이터 배포 및 확장]
- 읽기, 쓰기 에 대한 **부하 분산**  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/f514ae33-1573-4566-8128-b9ec51200438)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

- 논리적으로 분리된 데이터 베이스
  - 동일한 데이터베이스 엔진 및 하드웨어
  - 공유 데이터베이스 인프라가 고장 나면, 여러 마이크로서비스에 영향을 끼칠 수 있다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/dec3ac0a-c463-4612-8244-85cd88ceadb0)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

- 클라우드 기반
  - 마이크로서비스별 전용 데이터베이스
  - 관리 비용 절감(백업, 업그레이드, 페일오버)
  - 마이크로서비스 소유자는 공유 서비스에 의존하지 않을 수 있다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/8fe992b1-bc65-42bc-af37-9db16436f7be)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

### 8.1.3 환경
- dd 


## 8.2 마이크로서비스 배포의 원칙
- 몇 가지 핵심원칙
### 8.2.1 격리 실행
`마이크로서비스 인스턴스가 자체 컴퓨팅 자원을 가진 방식으로 실행하라.`

#### [호스트당 다수의 마이크로 서비스]
- 모니터링이 어려워 진다.
- 여러 서비스가 **컴퓨팅 자원을 공유**
  - 한 서비스 부하가 걸리면, 다른 서비스에 사용할 자원이 줄어든다.
- 여러서비스가 하나의 호스트의 있으므로 장애의 영향 분석이 복잡해진다.
- 의존성 충돌 가능성
- **독립적 배포 가능성 약화**  
![1](./images/ch08/img.png)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  


#### [호스트당 하나의 마이크로서비스]
- **서비스별 전용 자원**
- **서비스별 의존성 설치**  
![1](./images/ch08/img_1.png)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### [격리모델]
- 컨테이너의 격리 정도는 약하지만, **비용 효율 & 프로비저닝**이 빠르다.
- **컨테이너** 격리 기술은 **마이크로서비스 에서 중요한 선택지로 간주된다.** 
![1](./images/ch08/img_2.png)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

````
- 과거에는 머신의 격리를 위해 새로운 물리 서버를 구입하거나 임대
  - 비용과 시간이 많이 소요
- 주문형 컴퓨팅 플랫폼과 가상화 기술의 발전으로 **컴퓨팅 자원에 대한 비용이 대폭 감소**
````

### 8.2.2 자동화 집중
- 마이크로서비스의 수가 증가함에 따라 **자동화가 중요**해진다.
- 고수준의 **자동화를 가능하게 할 기술을 선택**하고 자동화를 **문화의 핵심 부분으로 채택**해야 한다.
---
- 마이크로서비스로 이전하면 운영 영역에서 **복잡성이 크게 증가**한다.
  - **자동화에 끊임없이 주력**해야 한다.
  - 자동화 작업을 수행할 **도구**와 **기술**을 선택해야 한다.
  - 마이크로서비스의 복잡성을 억제하려면 **자동화 문화를 수용**해야 한다.

#### 자동화의 능력에 대한 두 가지 사례 연구
- REA & 길트 라는 회사는 **자동화 도구를 채택하는데 많은 시간을 할애** 하였고, 장기적으로 **마이크로서비스의 사용을 견인하는 원동력**이 되었다.


### 8.2.3 코드형 인프라스트럭처
- 자동화를 용이하게 하고 정보 공유를 촉진하는 인프라스트럭처 코드를 구성을 기술하라
  - **terraform**, chef, puppet, ansible, pulumi, AWS CloudFormation 등
- 인프라스트럭처의 **코드 버전을 제어**하면 **이력 관리**를 할 수 있고, **감시자**와 **결함 추적**시 유익하다.

### 8.2.4 무중단 배포
- **사용자 다운타임 없이** 새 버전의 마이크로서비스를 배포할 수 있도록 **독립적인 배포를 강화**하라
- 무중단 배포를 구현할 수 있는 능력은 배포 속도 향상을 이끈다.(파이낸셜 타임즈, 사라웰스)
  - 릴리스 빈도 향상
- 릴리스 수행시, 업스트림 소비자가 알아채지 못하게 하는 것이 목표이다.
  - 마이크로서비스 특성에 크게 좌우된다.
  - 동기식 통신을 사용하고 있다면 문제가 될 수 있다.

### 8.2.5 기대 상태 관리
- 마이크로서비스를 지정된 상태로 유지할 수 있는 플랫폼을 사용해 **장애가 발생하거나 트래픽 증가**시 **새로운 인스턴스를 시작**할 수 있도록 하라.
- **기대 상태 관리**(desired state management)는 **어플리케이션 인프라를 자동으로 유지 관리하는 기능**이다.
  - 인스턴스 수 지정, 메모리 및 CPU 할당 
- 플랫폼 스스로 원하는 상태를 유지하는 방법을 관리한다.
  - 인스턴스가 죽거나 하부 하드웨어가 고장나더라도 **플랫폼이 문제를 처리**할 수 있다.
    - 플랫폼 : AWS 오토스케일링 그룹, 쿠버네티스, 노마드

![image](https://github.com/jongwanS/building_microservices/assets/30585897/c04ff40d-2746-4aa8-b860-47c9a82aae05)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### 전제조건
- **자동화된 배포**는 올바른 상태 관리를 위한 전제조건이다.
#### 깃옵스
- **기대 상태 관리 & 코드형 인프라스트럭처 통합**한다.
- 플럭스(Flux)와 같은 도구도 있다.

## 8.3 배포 방법
### 8.3.1 물리 머신
### 8.3.2 가상 머신
### 8.3.3 컨테이너
### 8.3.4 애플리케이션 컨테이너
### 8.3.5 PaaS
### 8.3.6 FaaS

## 8.4 어떤 배포가 적합할까?







