# 8. 배포

## 8.1 논리적에서 물리적으로
- 논리적 관점은 많은 복잡성을 숨겨준다.
- 물리적으로 어떤 종류의 정보가 숨어 있는지 살펴보자.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/ae05ef80-8530-4f04-9878-0da7880d3390)    
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

### 8.1.1 다수 인스턴스

#### [로드 밸러서 라우팅 형태]  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/b107a009-9c80-45ef-a662-897fdebff5f3)    
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### [여러 데이터 센터 분산 형태]  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/b56a6d24-65d4-4036-aeaa-eb8e7168edcb)    
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

### 8.1.2 데이터베이스
- 마이크로서비스 **인스턴스마다** 자신의 데이터베이스를 가져야 할까? -> **아니다**
  - 상태 조회, 조작하는 로직은 **논리적으로 하나의 마이크로서비스** 이다.
- 데이터베이스를 공유하지 말라는 규칙을 위반하지 않을까?
  - 아니다, 데이터베이스 액세스 및 조작하는 로직이 **다양한 마이크로서비스에 분산되는 것을 우려**하는 것이다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/8cce9d67-7b98-43a9-88c7-7309bab73d2f)    
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축

#### [데이터 배포 및 확장]
- 읽기, 쓰기 에 대한 **부하 분산**  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/f514ae33-1573-4566-8128-b9ec51200438)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### [논리적으로 분리된 데이터 베이스] (자체구축, 온프라미스에서 많이 사용)
  - 라이센스 비용절감
  - 동일한 데이터베이스 엔진 및 하드웨어
  - 공유 데이터베이스 인프라가 고장 나면, 여러 마이크로서비스에 영향을 끼칠 수 있다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/dec3ac0a-c463-4612-8244-85cd88ceadb0)    
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### [물리적으로 분리된 데이터 베이스, 클라우드 기반] 
  - 마이크로서비스별 전용 데이터베이스
  - 관리 비용 절감(백업, 업그레이드, 페일오버)
  - 마이크로서비스 소유자는 공유 서비스에 의존하지 않을 수 있다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/8fe992b1-bc65-42bc-af37-9db16436f7be)    
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

### 8.1.3 환경
- 각 환경은 소프트웨어를 개발하고 **운영 준비 상태를 테스트**할 수 있도록 **특정 목적을 수행**한다.
  - 개발자 노트북, CI 서버, 통합 테스트 환경 ...
- **모든 환경이 운영 환경의 정확한 복사본**이 된다면 **가장 이상적**이다.

#### [파이프 라인 예시]
- 운영 환경에 도달하기 전에 여러 환경을 거친다.
- 신속하게 문제를 해결할 수 있도록 소프트웨어 작동여부를 빨리 파악하는 것이 중요하다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/7bb21524-a299-45ea-b8ca-31f24b441eae)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### [다양한 환경별 마이크로서비스 배포 예시]
- 마이크로서비스의 토폴로지는 환경마다 변경된다.
- 환경별 정보(인스턴수 갯수 등..)는 배포된 **서비스 산출물과 분리**돼야 한다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/26d447a9-29c5-4987-8b6c-dbecff201805)    
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  



## 8.2 마이크로서비스 배포의 원칙
- 몇 가지 핵심원칙
### 8.2.1 격리 실행
- `마이크로서비스 인스턴스가 자체 컴퓨팅 자원을 가진 방식으로 실행하라.`

#### [호스트당 다수의 마이크로 서비스]
- 모니터링이 어려워 진다.(모호함)
- 여러 서비스가 **컴퓨팅 자원을 공유**
  - 한 서비스 부하가 걸리면, 다른 서비스에 사용할 자원이 줄어든다.
- 여러서비스가 하나의 호스트의 있으므로 장애의 영향 분석이 복잡해진다.
- 서비스 배포 복잡성 증대
  - 의존성 충돌 가능성 등
- 팀의 자율성 저해
- **독립적 배포 가능성 약화**  
![1](./images/ch08/img.png)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  


#### [호스트당 하나의 마이크로서비스]
- **서비스별 전용 자원**
- **서비스별 의존성 설치**  
![1](./images/ch08/img_1.png)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### [머신별 격리도]
- 과거에는 머신의 격리를 위해 새로운 물리 서버를 구입하거나 임대
  - 비용과 시간이 많이 소요
- 주문형 컴퓨팅 플랫폼과 가상화 기술의 발전으로 컴퓨팅 자원에 대한 비용이 대폭 감소
- 과거에 비해 컨테이너 기술은 많이 개선되었고, 다른 머신모델과의 격차를 많이 줄였다.
- 컨테이너의 격리 정도는 약하지만, **비용 효율 & 프로비저닝**이 빠르다.
- **컨테이너** 격리 기술은 **마이크로서비스 에서 중요한 선택지로 간주된다.**
  - 효율적인 리소스 관리, 스케일링 용이성, 독립성과 격리 ...   
![1](./images/ch08/img_2.png)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  


### 8.2.2 자동화 집중
- 마이크로서비스의 수가 증가함에 따라 **자동화가 중요**해진다.(서비스가 작게 쪼개지므로, 해야할일이 많아 진다)
- 고수준의 **자동화를 가능하게 할 기술을 선택**하고 자동화를 **문화의 핵심 부분으로 채택**해야 한다.
---
- 마이크로서비스로 이전하면 운영 영역에서 **복잡성이 크게 증가**한다.
  - **자동화에 끊임없이 주력**해야 한다. -> 개발 생산성 증가
  - 자동화 작업을 수행할 **도구**와 **기술**을 선택해야 한다.
  - 마이크로서비스의 복잡성을 억제하려면 **자동화 문화를 수용**해야 한다.

#### 자동화의 능력에 대한 두 가지 사례 연구
- REA & 길트 라는 회사는 **자동화 도구를 채택하는데 많은 시간을 할애** 하였고, 장기적으로 **마이크로서비스의 사용을 견인하는 원동력**이 되었다.


### 8.2.3 코드형 인프라스트럭처
- 자동화를 용이하게 하고 정보 공유를 촉진하는 **인프라스트럭처 코드를 구성을 기술하라**
  - **terraform**, chef, puppet, ansible, pulumi, AWS CloudFormation 등
- 인프라스트럭처의 **코드 버전을 제어**하면 **이력 관리**를 할 수 있고, **결함 추적**에도 유용하다.

### 8.2.4 무중단 배포
- **독립적인 배포 가능성을 강화**해 서비스 **사용자에게 다운타임 없이 새 버전의 마이크로서비스를 배포할 수 있어야 한다.**
---
- **사용자 다운타임 없이** 새 버전의 마이크로서비스를 배포할 수 있도록 **독립적인 배포를 강화**하라
- 무중단 배포를 구현할 수 있는 능력은 **릴리스 빈도 향상**을 이끈다.(파이낸셜 타임즈, 사라웰스)
- 릴리스 수행시, **업스트림 소비자가 알아채지 못하게 하는 것이 목표**이다.
  - 마이크로서비스 특성에 크게 좌우된다.
    - 동기식 : 문제가 생길 여지가 있다.
    - 비동기식 : 메시지를 다시 읽어 실행 하면 되기 때문에 쉽게 구현 가능 

### 8.2.5 기대 상태 관리
- 마이크로서비스를 지정된 상태로 유지할 수 있는 플랫폼을 사용해 **장애가 발생하거나 트래픽 증가**시 **새로운 인스턴스를 시작**할 수 있도록 하라.
---
- **기대 상태 관리**(desired state management)는 **어플리케이션 인프라를 자동으로 유지 관리하는 기능**이다.
  - 인스턴스 수 지정, 메모리 및 CPU 할당 
- **플랫폼 스스로 원하는 상태를 유지하는 방법을 관리**한다.
  - 인스턴스가 죽거나 하부 하드웨어가 고장나더라도 **플랫폼이 문제를 처리**할 수 있다.
    - 플랫폼 : AWS 오토스케일링 그룹, 쿠버네티스, 노마드  

![image](https://github.com/jongwanS/building_microservices/assets/30585897/c04ff40d-2746-4aa8-b860-47c9a82aae05)    
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### 전제조건
- **자동화된 배포**는 올바른 상태 관리를 위한 전제조건이다.
#### 깃옵스
- **기대 상태 관리 & 코드형 인프라스트럭처 통합**한다.
- 깃옵스와 비슷한 플럭스(Flux)와 같은 도구도 있다.

## 8.3 배포 방법
- 몇 가지 배포 방식 소개
### 8.3.1 물리 머신
- 마이크로서비스는 가상화 없이 `물리 머신에 직접 배포`된다.
--- 
- 마이크로서비스를 `직접 물리 머신에 배포`하는 방식
  - 직접 = **가상화X, 컨테이너X**
- 물리 하드웨어에 직접 배포하면 **자산 전체의 활용도가 낮아질 수 있다.**
  - 자원낭비 가능성(하드웨어에서 제공하는 CPU,메모리,I/O를 절반만 사용) 
- 동일 머신에 여러 마이크로서비스를 패키징하고 싶은 유혹을 받을 수 있다.
  - **격리된 실행 환경 원칙을 위반**
- **퍼펫**이나 **셰프**와 같은 도구를 사용해 `기대 상태 관리`,`무중단 배포`를 구현할 수 있지만, **물리 머신 배포와는 어울리지 않는다**.
  - `가상머신 or 컨테이너 기술 조합`이 더 적합하다.

### 8.3.2 가상 머신
- 마이크로서비스 인스턴스는 **가상 머신에 배포**된다.
--- 
- 가상화는 기존 물리머신을 **더 작은 가상 머신으로 분할**하게 함으로써 데이터 센터를 변화 시켰다.
- VMware, 가상 머신 인프라(Ec2)는 컴퓨팅 인프라의 사용도를 높이고 **호스트 관리 부담을 줄이는데 이점**을 제공한다.
  - CPU, 메모리, I/O, 스토리지를 **가상 머신에 할당**
  - 환경 분리 및 격리(서로 간의 영향을 최소화)
  - 스케일링 및 유연성
- 각 인스턴스가, 개별 VM에 배포될 때 인스턴스간 훌륭한 **격리 수준 보장** 된다.
- 하지만 하부 하드웨어가 고장나면 **서비스 인스턴스가 손실되는 문제가 여전히 존재**한다.
#### [가상화 비용]
- **수확 체감 현상**
  - 많은 가상 머신을 같은 하부 하드웨어에 넣을수록 효용이 떨어지는 현상
- 하이퍼바이저 역할 2가지
  - CPU, 메모리 자원, I/O를 물리 호스트로 매핑
  - 제어 계층 역할, 가상 머신 자체를 조작
- **하이퍼바이저가 작업**을 수행하기 위해 **자원을 별도로 확보**해야한다.
  - 관리 호스트가 많을수록 하이퍼바이저에 더 많은 자원을 확보해야한다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/a8bb3a5a-c5cd-4d0d-95d5-e50f0f44212f)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### [마이크로서비스에 적합한가?]
- 격리 측면에서는 우수하지만, 비용이 발생한다.
- 자동화 용이성은 **사용 중인 기술에 따라 달라**진다.
- 클라우드에서 제공하는 **관리형 VM**(Ec2..등)을 통해 쉽게 자동화 할 수 있다.
  - 자동 확장 그룹, 무중단 배포
  - 전통적 가상화 플랫폼에서 제공하는 관리형VM은 중앙 통제를 받는 경향이 있어, 자동화 기능이 제한될 수 있다.
- 가상 머신이 제공하는 **엄격한 격리 수준이 필요**하거나 컨테이너화 능력이 없다면 VM이 훌륭한 선택이다.

### 8.3.3 컨테이너
- 마이크로서비스 인스턴스는 가상 또는 물리머신에서 **격리된 컨테이너로 실행**된다.
- 컨테이너 런타임은 쿠버네티스와 같은 **컨테이너 오케스트레이션 도구로 관리**할 수 있다.
--- 
- **마이크로서비스 아키텍처를 실행하기 위한 실질적인 선택지**가 됐다.
  - 도커 대중화 + 컨테이너 관리도구(쿠버네티스)
- 컨테이너가 정확히 무엇인지 이해, **가상 머신과의 차이점**을 살펴봐야한다.
#### [다른 방식의 격리]
**가상머신 vs 컨테이너**
- 하이퍼바이저가 필요 없다.-> **자원절약**
- **프로비저닝**이 가상머신에 비해 **빠르다**.
- 세밀한 리소스 할당 가능 -> 하드웨어 활용 최적화
- 컨테이너는 **공유 커널의 일부를 사용**한다.
  - 각 컨테이너의 프로세스 트리는 커널 안에 있다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/43c634d0-9b60-4502-a645-22a31e38b04c)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축

- 일정 격리 수준 보장
- 비용 효과적
  - VM보다 격리비용이 작다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/be8f132b-b4a0-4020-bae9-754adeb774a2)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### [완전하지는 않다]
- 컨테이너들이 외부 세계와 소통할수 있는 방법이 필요하다.
  - 도커의 도입이 해당 문제에 큰 도움을 주었다.
- 리소스 관점
  - 가상 머신 격리 수준처럼 **완전하게 동일하게 리소스가 할당 되지 않는다.**

#### [윈도 컨테이너]
- 리눅스와 비교할때 윈도 운영체제가 상당히 크다.
#### [도커]
- 컨테이너 프로비저닝을 관리
- 네트워킹 문제 처리
- 자체 레지스트리
- `이미지 개념 도입`
  - 산출물로 도커 이미지 생성, 레지스트리에 저장
- 도커 이미지를 빌드하거나, 이미지를 가져와 로컬에서 쉽게 실행할 수 있다.
- 여러 머신에서 컨테이너를 관리하기위해 `도커 스웜`, `도커 스웜 모드`를 출시
  - 하지만, **수많은 컨테이너를 관리할 경우 쿠버네티스가 최고**이다.

#### [마이크로서비스에 대한 적합성]
- 컨테이너는 **마이크로서비스에 매우 적합**하다.
- 하부 기술을 숨겨 **다양한 기술 스택을 혼합**할 수 있다.
- **기대 상태 관리와 같은 개념을 구현하려면 쿠버네티스와 같은 플랫폼이 필요**하다.

### 8.3.4 애플리케이션 컨테이너
- 마이크로서비스 인스턴스들이 하나의 컨테이너에서 실행되는 구조
---
- 런타임 오버헤드를 줄이는 이점이 있다.
  - 하나의 JVM 오버헤드만 발생
- 단점이 훨씬 많다.
  - 기술 선택의 제한
  - 자동화 및 관리측면 제한(선별 오토스케일링 불가)
  - 어플리케이션 컨테이너가 제공하는 기능의 가치 의문
    - 세션 클러스터링 -> 서비스 확장시 피하고 싶은 대상
  - 리소스 사용 및 스레드 분석이 훨씬 더 복잡하다.
  - **부족한 격리 수준**은 해당 아키텍처를 사용하지 않는 주된 이유가 됐다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/4dbd1642-ff7c-4e06-b95f-12e52411e92b)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

### 8.3.5 PaaS
- Paas(Platform as a Service) 더 고수준의 추상화에서 작업하게 된다.
- 제대로 동작하지 않을때는 문제를 해결하기 위해 내부에 접근할 수 있는 **권한이 많지 않다**.
  - Paas가 더 똑똑해지려고 할 수록, 더 많은 문제가 발생하는 경우가 많다.
### 8.3.6 FaaS
- 쿠버네티스에 근접한 유일한 기술은 `서버리스` 이다.
- `머신 관리`와 `구성`에 대한 상세 내용은 사용자에게 **가려진다**.
- FaaS(Function as a Service) = `서버리스`
- AWS 람다
  - 실행되지 않는 코드는 비용이 들지 않는다.
  - 사용한 만큼만 비용 지불(on-demand)
  - 트래픽을 예측할 수 없는 상황에서 훌륭한 선택지(오토스케일링)
- FaaS 플랫폼을 사용하면 **운영 부담을 크게 줄일 수 있다.**

#### [제한 사항]
- 일종의 컨테이너 기술을 사용한다.
  - 함수의 실행 환경을 자세하게 설정하거나 제어하는 것이 어려울 수 있다.
- FaaS 제공자에 따라 언어 제약이 있다.
- 함수 호출 시간에 제약이 있다.
  - GCP 9분, AWS 15분, Azure 무제한
- **함수 호출은 무상태**(stateless)로 간주되며, **이전 호출에 남겨진 상태에 액세스할 수 없다.**
  - Azure 영속 함수로 함수를 일시 중지하고, 다시 시작할 수 있다.(AWS 스텝함수 보다 개발 친화적)

````
켄 프롬, '소프트웨어와 앱의 미래는 왜 서버리스인가?
- 개발자가 더 이상 서버에 대해 생각할 필요가 없다.
- 컴퓨팅 자원 & 용량을 관리할 필요가 없다.
 > 공급자가 관리
````
````
웹 어셈블리(Wasm)
- 다양한 언어로 작성된 샌드박스 프로그램을 브라우저에서 실행하는 방법을 제공하는 공식 표준
````

#### [문제점]
- 시작 시간(spin-up time)
  - 새로운 런타임을 가동하는 데 드는 **콜드 스타트(cole start) **
    - jvm, .NET
- 함수의 동적 확장
  - 함수 동시 호출에 대한 제한이 있다.
  - 시스템의 한 부분은 동적으로 확장 가능하나, 호출대상이 그렇지 않다면 문제가 생긴다.
#### [마이크로서비스와 매핑]

#### 마이크로서비스당 함수 매핑
  - `단일 함수`로 배포
  - 자원에 대한 요청이 **동일한 진입점**을 통해 들어오며, 요청 **경로를 기반**으로 단일 함수 내에서 분기 실행한다.  
![image](https://github.com/jongwanS/building_microservices/assets/30585897/e94f2816-d07e-4e9c-987e-9971f200f0f9)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### 애그리거트당 함수 매핑
  - `애그리거트별 함수 분리`
  - `독립적`으로 배포 가능
- 주의사항
  - 첫째 : 더 크게 분류된 외부 인터페이스를 유지 해야한다.
    - 크게 분류하여야 재결합하거나, 애그리거트 모델을 재구성하려는 경우, 소비자에게 영향을 주지 않는다.
  - 두번째 : 데이터
    - 같은 팀이 모든 기능을 관리하고 개념적으로 단일한 서비스라면 **동일한 DB** 사용하는 것이 좋다.
    - 각 애그리거트 함수의 요구 사항이 달라지면 DB 사용을 **분리** 하는 것 이 좋다.
    - 업스트림 소비자에게는 여전히 단일 마이크로서비스로 표시할 가치가 있다.

![image](https://github.com/jongwanS/building_microservices/assets/30585897/0c02034d-4cbe-453b-aa01-7b07fe8e090a)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

![image](https://github.com/jongwanS/building_microservices/assets/30585897/61a1fa4b-8d1e-467b-b85b-bf11cfbc5377)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

![image](https://github.com/jongwanS/building_microservices/assets/30585897/1c236fc4-42e8-431d-85ed-1ed3169d12bb)  
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

#### 심지어 더욱 세분화한다.
- 애그리거트당 기능을 더 작은 조각으로 나눈다면?
- 애그리거트 핵심 원칙을 위반한다.
  - **애그리거트를 단일한 단위**로 취급해야 한다.
- 함수로 처리될 수 있는 하나의 애그리거트를 관리하는데, 이러한 복잡성을 추가할 가치가 있는지 의문

#### [향후 전망]
- 향후 대부분의 개발자가 하부 상세 내용을 숨기는 플랫폼을 사용하게 될 것이다.
- 쿠버네티스를 지원하는 FaaS 제품에 점점 더 많은 작업이 진행되고 있다.
- 더 많은 조직이 일부분 FaaS를 채택하고 있다.
  - ex) BBC 
## 8.4 어떤 배포가 적합할까?







