# 9. 테스트
- 기능이 분산 시스템에 걸쳐 있을경우, 효율적으로 테스트하는 방법에 대한 문제는 남아있다.
- 테스트는 많은 분야를 다룬다.
  - 단위, 통합, 인수, 성능, 회귀
- **마이크로서비스를 테스트시 다른 차원의 복잡성이 추가**된다.
- **이전에는 주로 소프트웨어가 운영되기 전에 테스트를 진행**했지만, **점점 운영 환경에 진입 후 테스트를 수행**한다.
  - 개발과 운영 활동 사이의 경계가 모호해지고 있다.

## 9.1 테스트 유형
- 브라이언 마릭, 테스트를 위한 분류시스템 고안
  - **테스트 사분면**  
  ![1](./images/ch09/img.png)        
  출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축        
- **기술 대면 테스트**
  - 개발자가 시스템 구축하는 데 도움을 주는 테스트
    - `성능 테스트`, `단위 테스트`
    - `자동화` 되어 해당 테스트를 진행 한다.
- **비즈니스 대면 테스트**
  - `비기술 이해관계자`가 `시스템 작동 이해도를 돕는 테스트` 이다.
    - 인수 테스트
    - 탐색 테스팅
      - 수동 테스팅(UAT)
- 위의 테스트는  **운영 전 검증에 초점**을 맞춘다.
- 테스트를 통해 운영 환경에 배포되기 전에 충분한 품질을 갖췄는지 확인한다.
- 최근에는 가능한 한 **많은 반복 테스트를 자동화** 하기 위해 **수동 테스트에서 벗어나는 분위기** 이다.

> **수동 탐색 테스팅**  
  > 이전에는 수동으로 수행했던 작업을 자동화 할 수 있게 됐다.  
  > 수동으로 했던 작업이 자동화 되므로, 덜 반복적인 탐색 테스팅에 집중할 수 있는 시간을 확보하게 됐다.   
  > 수동 테스팅은 테스트 작성 비용으로 인해 자동화된 테스트를 구현하지 못할 경우 중요하다.  

> **테스트 유형**   
> - 단위 테스트(Unit Testing)  
>   - 코드의 함수, 메소드, 클래스 부분을 테스트
> - 속성 테스트 (Attribute Testing)
>   - 소프트웨어의 특정 속성(보안,성능,신뢰성,호환성) 테스트
> - 탐색테스트(Exploratory Testing)
    >   - 탐색 테스트는 미리 계획된 테스트 케이스나 스크립트 없이 테스터가 시스템을 조사하고 탐색하는 테스트
> - 인수 테스트(Acceptance Testing)
>   - 소프트웨어나 시스템이 계약된 요구사항을 충족시키는지 확인

## 9.2 테스트 범위
- 마이크 콘은 `어떤 유형의 자동화 테스트`가 필요한지 `테스트 피라미드 모델을 소개`했다.
- 마이크 콘의 테스트 피라미드  
  ![1](./images/ch09/img_1.png)    
  출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  
  - **올라갈수록 테스트 범위가 증가**하며, 테스트 중인 기능이 작동한다는 확신이 커진다.
    - 하지만, **테스트 시간이 오래**걸리며, 실패시 어떤 기능이 손상됐는지 확인하기 더 어렵다.
  - **내려갈수록 테스트가 훨씬 빠르다**.
    - 피드백 주기가 향상된다.
    - 고장 난 기능을 더빨리 발견한다.
    - 지속적 통합 빌드 빠르다.
  - 테스트 피라미드의 문제점은 **모든 용어가 사람마다 다른 의미**를 갖는다.
    - `서비스`라는 의미는 다중적, `단위` 테스트 정의는 사람마다 다름
    - 필자는 UI테스트를 `엔드투엔드` 테스트라고 부르는것을 선호한다.
### 9.2.1 단위 테스트
- **단위 테스트**는 `단일 함수` 또는 `메서드 호출을 테스트`한다.
  - **테스트 주도 설계**(TDD)도 단위 테스트에 포함
- **단위 테스트에서는**
  - **마이크로서비스를 시작하지 않는다.**
  - **외부 파일 사용 및 네트워크 연결도 제한**된다.
- **단위 테스트의 핵심목표**
  - 기능이 정상적으로 작동하는지 **빠른 피드백 제공**
  - **코드 리팩터링을 지원**하는 데 중요
![1](./images/ch09/img_3.png)      
출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  


> **용어 정리**  
> - Test-Driven Development
>   - 코드 작성 단계에서 **테스트를 먼저 작성하는 개발 방법**
>   - Write a failing test case.  
      Write code to make the test pass.  
      Refactor the code to improve its design, performance, and other aspects.  
> - Test-Driven Design
>   - 디자인 단계에서 테스트를 기반으로 **시스템 아키텍처를 설계**하는 방법
>   - Write a specification for the system's behavior in the form of a test.  
      Write code to make the test pass.  
      Refactor the code to improve its design, performance, and other aspects.  

### 9.2.2 서비스 테스트
- **서비스 테스트**는 사용자 인터페이스를 우회하고 **마이크로서비스를 직접 테스트**하도록 설계 됐다.
- 여러 마이크로서비스로 구성된 시스템일지라도, **서비스 테스트**는 **개별 마이크로서비스의 기능을 테스트** 한다.
  - 테스트 실패의 원인은 테스트 중인 마이크로서비스로 제한돼야 한다.
  - [그림 9-5]와 같이 외부 협업자를 모두 쳐내야한다.
  ![1](./images/ch09/img_4.png)       
  출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  
- 실제 **데이터베이스**에 대해 테스트하거나 **네트워크**를 통해 스텁 다운스트림 협업자와 통신하기로 결정한다면 **테스트 시간은 늘어 날 수 있다**.
- 단위 테스트보다 더 넓은 범위를 다루기 때문에, **단위 테스트보다 문제 탐지가 더 어렵다**.
  - 광범위한 테스트보다는 취성(깨지기 쉬운 성질)이 낮다.

### 9.2.3 엔드투엔드 테스트
- 엔드투엔드 테스트는 **시스템 전체에 대해 테스트를 수행**한다.
- 엔드투엔드 테스트는 **마이크로서비스 맥락에서 제대로 테스트하기 까다롭다.**
  ![1](./images/ch09/img_5.png)       
  출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

> **통합 테스트는 어떤가?**  
> 사람마다 통합 테스트를 부르는 기준이 다름  
> - 어떤사람은 두 서비스 간의 상호작용, 코드와 데이터베이스 간의 연결만 담당  
> - 어떤사람은 엔드투엔드 테스트와 동일하게 사용

### 9.2.4 절충안
- 단위 테스트는 범위가 작으므로 실패를 빨리 찾을 수 있다.
- 테스트 범위가 커질수록 신뢰도는 높아지지만, 테스트 실행 시간이 길어져 피드백이 느려진다.
- 최적안을 찾기위해 테스트 유형별 테스트 수를 알맞게 조절해야 할 경우가 많다.
- 서비스 또는 엔드투엔드 테스트와 같은 **넓은 범위의 테스트가 실패하면** 더 작은 범위의 **단위 테스트를 작성해 실패한 부분을 더 빨리 찾아야 한다**.
  - **범위가 더 큰 일부 테스트를 빠른 단위 테스트로 대체하라.**
- `안티패턴`은 **테스트 아이스크림콘** 또는 **역피라미드**이다.
  - 작은범위의 테스트가 거의 없고, 넓은 범위의 테스트에서 모든영역을 커버한다.
  - 테스트가 매우 느리게 수행, 피드백 주기가 매우 길다.
  ![1](./images/ch09/img_6.png)       
  출처 : [https://k-hartanto.medium.com/testing-pyramid-and-testing-ice-cream-cone-what-is-the-difference-6ddde3876c20]()

## 9.3 서비스 테스트의 구현
- 서비스 테스트는 전체 마이크로서비스에서, 해당 마이크로서비스의 기능 일부를 테스트한다.
- 서비스 테스트 집합은 다운스트림 협업자를 쳐내고 **테스트중인 마이크로서비스**를 **스텁 서비스에 연결하도록 구성해야 한다**.
- 스텁 서비스에서 응답을 보내도록 구성해야한다.
### 9.3.1 목 또는 스텁 사용
- `목` 또는 `스텁`을 통해 **다운스트림 협력자를 스텁**한다.
  - mock : 클래스나 인터페이스를 시뮬레이션 
  - stub : 미리 정해 놓은 값을 반환
  - 제라스 메스자로스는 목과 스텁을 포함해 **테스트 더블(Test Double)** 라고 부른다.
> [테스트 주도 개발로 배우는 객체 지향 설계와 실천] - 스티브 프리먼, 프라이스
  
### 9.3.2 더 영리한 스텁 서비스
- **마운티뱅크**(Mountebank) 
  - 테스트 더블(Test Double)을 지원하는 첫번째 오픈소스 도구
  - 마이크로서비스 대신 마운티뱅크를 지정, 기존의 Stub 이나 Mock을 이용한 것과 동일하게 테스트를 수행
  - 메시징 프로토콜에 대한 스텁은 지원하지 않는다.
  - 고객 마이크로서비스 테스트시
    - 멤버십 서비스 역할을 하는 **마운티뱅크 인스턴스 시작**
    ![1](./images/ch09/img_4.png)       
    출처 : 한빛미디어 - 마이크로서비스 아키텍처 구축  

## 9.4 까다로운 엔드투엔드 테스트의 구현
- 시작
### 9.4.1 불안정하고 깨지기 쉬운 테스트
### 9.4.2 누가 엔드투엔드 테스트를 작성하는가?
### 9.4.3 엔드투엔드 테스트는 얼마나 오래 걸릴까?
### 9.4.4 대규모 적체
### 9.4.5 메타버전
### 9.4.6 독립적인 테스트 가능성 부족


## 9.5 엔드투엔드 테스트를 피해야 할까?
### 9.5.1 계약 테스트와 소비자 주도 계약
### 9.5.2 결론
## 9.6 개발자 경혐
## 9.7 운영 전 테스트에서 운영 중 테스트로
### 9.7.1 운영 환경 테스트 유형
### 9.7.2 운영 환경에서 안전한 테스트 만들기
### 9.7.3 MTBF 보다 MTTR?
## 9.8 교차 기능 테스트
### 9.8.1 성능 테스트
### 9.8.2 견고성 테스트

#### [요약]
