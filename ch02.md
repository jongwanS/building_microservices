# 2. 마이크로서비스 모델링 방법
## 2.1 뮤직코프 소개
## 2.2 올바른 마이크로서비스 경계를 만드는 것은 무엇인가?
- 본질적으로 마이크로서비스는 모듈식 아키텍처의 한 형태이다.
  - 모듈식 소프트웨어 & 구조적 프로그래밍 영역에 존재하는 많은 선행기술에 의지하여 경계를 나누는데 도움을 받을 수 있다.
  - 올바른 경계를 나누기위한 핵심 3가지(정보 은닉, 응집력, 결합)
### 2.2.1 정보은닉
- 모듈(또는 마이크로서비스) 경계 뒤에 가능한 한 세부정보 노출을 최소화
- 장점
  - 향상된 개발시간 : 모듈별 개발하므로 병렬적으로 개발 가능
  - 이해도 : 모듈별로 살펴볼 수 있으므로, 쉽게 이해할 수 있음
  - 유연성 : 모듈별로 독립적이므로, 기능을 변경하기 용이 / 모듈을 합쳐 새로운 기능 제공 가능
### 2.2.2 응집력
- **함께 바뀌고 함께 머무는 코드**
- **마이크로 서비스**는 강한 응집력을 목표로 한다.
  - 비지니스 기능을 추가하기위해 여러 서비스를 배포할 경우, 독립적 배포 불가 
### 2.2.3 결합
- 마이크로서비스간 느슨한 결합해야 한다.
- 마이크로서비스의 핵심은 다른 서비스를 변경하지 않고도 **하나의 독립적 서비스를 배포**할 수 있다는것.
### 2.2.4 결합과 응집력의 연관성
- 마이크로서비스별 결합도는 낮추고, 응집력은 높이자.
  - 응집력 : 개별 마이크로서비스
  - 결합 : 마이크로서비스간의 결합
- 서비스별 경계에 안전성 필요
  - 마이크로서비스가 제공하는 계약이 하위 호환성을 유지시켜야 한다.

## 2.3 결합유형
- 결합을 평가하는 모델 중 상당수는 **코드 수준**에서 주로 이야기 된다.
- 마이크로서비스는 모듈식 아키텍처의 한 형태이며, 이전부터 모듈식 아키텍처를 해결하기 위해 다양한 연구가 있었다.
  - 구조적 프로그래밍의 같은 개념을 활용하여, 마이크로서비스 기반 시스템 관점에서 적용 시킬 수 있다.
- 결합유형 4가지(오른쪽으로 갈수록 결합도가 높음, 응집도 낮음)     
  ![1](./images/ch02/img_1.png)
### 2.3.1 도메인 결합
![1](./images/ch02/img.png)  
- 하나의 마이크로서비스가 다른 마이크로서비스의 **기능을 사용**하기 위해 상호작용해야 하는 상황
- 마이크로서비스 아키텍처에서 이 유형의 상호작용은 대개 불가피하다.
  - 최소한으로 유지해야 한다.
  - 꼭 필요한 것만 공유하고, 최소한의 데이터만 전송해야 한다.
- 시간적 결합  
 ![1](./images/ch02/img_2.png)
  - 하나의 마이크로서비스가 작업을 완료하기 위해, 동시간에 다른 마이크로서비스의 서비스를 필요로 하는 상황
    - 다른 마이크로서비스에 이상이 있을경우, 호출부 마이크로서비스에도 영향을 끼침
  - 메시지 브로커를 통해 이를 해결할 수 있다.

### 2.3.2 통과 결합
![1](./images/ch02/img_3.png)  
- 하위 마이크로서비스가 데이터가 필요로 한다는 이유만으로 하나의 마이크로서비스가 다른 마이크로서비스의 데이터를 전달하는 형태
  - 호출 마이크로서비스에서 또다른 마이크로 서비스를 알아야 하는 단점
  - 하위에서 데이터를 변경하면 상위에서 더 큰 변경을 초래할 수 있다.
- 예시의 통과 결합을 줄이기 위한 해결책  
  1. 통과 결합 -> 도메인 결합으로 변경(주문 처리기가 복잡해짐)   
    ![1](./images/ch02/img_4.png)
  2. 주문서비스와 창고서비스의 계약을 통해 데이터를 받는형태로 변경(창고 서비스가 배송목록 전달)
    - 배송서비스 계약이 변경되도 주문서비스에는 변경할 필요 없다.  
  ![1](./images/ch02/img_5.png)
  3. 주문 처리기에서 주문 요청의 일부로 배송목록을 보내고, 창고 서비스는 단지 전달만 한다면 창고 서비스는 변경이 불필요하다.
### 2.3.3 공통 결합
- 둘 이상의 마이크로서비스가 공통 데이터 집합을 사용하는 형태  
  ![1](./images/ch02/img_6.png)
  - 동일한 공유데이터베이스, 공유 메모리, 공유 파일 시스템
  - 데이터 구조를 변경하면 여러 마이크로서비스에 영향을 미친다.
- 둘 이상의 마이크로 서비스가 동일 주문레코드를 업데이트 하는 형태  
  ![1](./images/ch02/img_7.png) 
  1. 상태 기계를 만들어 해결(하지만, 상태 기계를 관리하는 책임을 공유)  
    ![1](./images/ch02/img_8.png)
  2. 하나의 마이크로서비스가 주문 상태를 관리하게 만듬  
    ![1](./images/ch02/img_9.png) 
  - 여러 서비스가 공유 데이터베이스에 접근하여 고비용SQL을 처리하므로, 문제가 될 가능성이 크다.
### 2.3.4 내용 결합
- 상위 서비스가 하위 서비스의 내부까지 도달해 서비스의 내부 상태를 변경하는 형태  
  ![1](./images/ch02/img_10.png)
  - 다른 마이크로서비스의 DB에 직접 변경하는 외부 서비스
  - 주문 테이블의 내부 데이터 구조가 외부에 노출되는 문제가 있다.
  - 외부에서 직접 DB를 액세스하도록 허용하면 외부 계약의 일부가 되어 변경 가능한 부분과 불가능한 부분을 쉽게 추론 할 수 없다.
  - 내용 결합은 피하라.



## 2.4 딱 도메인 주도 설계만큼
### 2.4.1 보편언어
### 2.4.2 애그리거트
### 2.4.3 경계 콘텍스트
### 2.4.4 애그리거트와 경계 콘텍스트를 마이크로서비스에 매핑
### 2.4.5 이벤트 스토밍


## 2.5 마이크로서비스를 위한 도메인 주도 설계 사례
## 2.6 비지니스 도메인 경계에 대한 방안
## 2.7 혼잡 모델과 예외

## 요약
